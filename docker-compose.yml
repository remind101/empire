version: '2'

services:
  server:
    build: .
    entrypoint: ""
    command:
      - bash
      - -c
      - "/go/bin/empire migrate && make test"
    links:
      - db:db
    ports:
      - "8080:8080"
    volumes:
      - ~/.dockercfg:/root/.dockercfg
      - "/var/run/docker.sock:/var/run/docker.sock"
    env_file: .env
    user: root
    environment:
      EMPIRE_DATABASE_URL: postgres://postgres:postgres@db/postgres?sslmode=disable
      DOCKER_HOST: unix:///var/run/docker.sock
      EMPIRE_X_SHOW_ATTACHED: 'true'
  db:
    image: postgres
