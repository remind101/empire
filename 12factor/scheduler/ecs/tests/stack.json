{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Stack for 12factor ECS scheduler integration tests",

  "Resources": {
    "Cluster": {
      "Type": "AWS::ECS::Cluster"
    },

    "User": {
      "Type": "AWS::IAM::User",
      "Properties": {
        "Policies": [{
          "PolicyName": "ecs",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": [
                  "ecs:DescribeTaskDefinition",
                  "ecs:RegisterTaskDefinition",
                  "ecs:CreateService",
                  "ecs:UpdateService",
                  "ecs:DescribeServices",
                  "ecs:ListServices",
                  "ecs:DeleteService"
                ],
                "Resource": [
                  "*"
                ]
              },
              {
                "Effect": "Allow",
                "Resource": ["*"],
                "Action": [
                  "ecs:DescribeTasks",
                  "ecs:ListTasks",
                  "ecs:StopTask",
                  "ecs:RunTask"
                ],
                "Condition": {
                  "ArnEquals": {
                    "ecs:cluster": {
                      "Fn::Join": ["", ["arn:aws:ecs:us-east-1:", { "Ref": "AWS::AccountId" }, ":cluster/", { "Ref": "Cluster" }]]
                    }
                  }
                }
              }
            ]
          }
        }]
      }
    },

    "AccessKey": {
      "Type": "AWS::IAM::AccessKey",
      "Properties": {
        "Status": "Active",
        "UserName": { "Ref": "User" }
      }
    }
  },

  "Outputs": {
    "AwsAccessKeyId": {
      "Description": "AWS_ACCESS_KEY_ID",
      "Value": { "Ref": "AccessKey" }
    },
    "AwsSecretAccessKey": {
      "Description": "AWS_SECRET_ACCESS_KEY",
      "Value": { "Fn::GetAtt": [ "AccessKey", "SecretAccessKey" ] }
    },
    "AwsRegion": {
      "Description": "AWS_REGION",
      "Value": { "Ref": "AWS::Region" }
    },
    "Cluster": {
      "Description": "ECS_CLUSTER",
      "Value": { "Ref": "Cluster" }
    }
  }
}
